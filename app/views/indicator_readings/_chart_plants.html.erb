<%# app/views/indicator_readings/_chart_plants.html.erb %>
<% uniq = "plantsCompareChart" %>
<div class="card h-100">
  <div class="card-body">
    <h2 class="h6 mb-3">
      Comparativa por planta
      <% if month.present? %>â€” <%= I18n.l(month, format: "%B %Y").capitalize %><% end %>
    </h2>
    <div style="height:380px"><canvas id="<%= uniq %>"></canvas></div>
  </div>
</div>

<%= javascript_tag nonce: true do %>
(function(){
  const elId = "<%= uniq %>";
  const payload = <%= raw({ labels: (labels||[]), datasets: (datasets||[]) }.to_json) %>;

  function ensureChartJsLoaded(cb){
    if (window.Chart) return cb();
    const s = document.createElement("script");
    s.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js";
    s.crossOrigin = "anonymous"; s.onload = cb; document.head.appendChild(s);
  }

  function render(){
    const el = document.getElementById(elId);
    if (!el || !payload.labels?.length || !payload.datasets?.length) return;

    window.__charts = window.__charts || {};
    if (window.__charts[elId]) { window.__charts[elId].destroy(); }

    window.__charts[elId] = new Chart(el, {
      type: "bar",
      data: {
        labels: payload.labels,
        datasets: payload.datasets.map(ds => ({ label: ds.label, data: ds.data, borderWidth: 1 }))
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: "bottom" },
          tooltip: {
            mode: "index", intersect: false,
            callbacks: {
              label: (ctx) => `${ctx.dataset.label}: ${Math.round(ctx.parsed.y ?? 0)}%`
            }
          }
        },
        interaction: { mode: "index", intersect: false },
        // Para apilar, cambia scales por:
        // scales: { x:{ stacked:true }, y:{ stacked:true, beginAtZero:true, ticks:{ precision:0, callback:v=>`${v}%` } } }
        scales: { y: { beginAtZero: true, ticks: { precision: 0, callback: v => `${v}%` } } }
      }
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => ensureChartJsLoaded(render));
  } else {
    ensureChartJsLoaded(render);
  }
})();
<% end %>
