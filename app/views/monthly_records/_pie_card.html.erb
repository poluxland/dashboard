<%# locals:
    id:      string único para el canvas (obligatorio)
    title:   título a mostrar (obligatorio)
    labels:  array de etiquetas (obligatorio)
    data:    array de números (obligatorio)
%>

<div class="card mb-3">
  <div class="card-body">
    <h2 class="h5 mb-3"><%= title %></h2>
    <div style="height:340px">
      <canvas id="<%= id %>"></canvas>
    </div>
  </div>
</div>



<%= javascript_tag nonce: true do %>
  (function(){
    function ensureChart(cb){
      if (window.Chart) return cb();
      var s = document.createElement("script");
      s.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js";
      s.crossOrigin = "anonymous";
      s.onload = cb;
      document.head.appendChild(s);
    }

    function draw(){
      var el = document.getElementById("<%= id %>");
      if (!el) return;
      var key = "_pie_" + "<%= id %>";
      if (window[key]) window[key].destroy();

      var labels = <%= raw(labels.to_json) %>;
      var data   = <%= raw(data.to_json) %>;

      window[key] = new Chart(el, {
        type: "pie",
        data: {
          labels: labels,
          datasets: [{
            data: data
            // sin colores: Chart.js usará su paleta por defecto
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "bottom" },
            tooltip: {
              callbacks: {
                // Solo una línea: "<porcentaje>% <etiqueta>"
                label: function (ctx) {
                  const total = ctx.dataset.data.reduce((a,b)=>a + Number(b), 0) || 1;
                  const val   = Number(ctx.raw) || 0;
                  const pct   = Math.round((val / total) * 1000) / 10;
                  return `${pct}% ${ctx.label}`;
                },
                title: function () {
                  // elimina el título (evita duplicar la etiqueta)
                  return '';
                }
              }
            }
          }
        }
      });
    }

    var init = function(){ ensureChart(draw); };
    document.addEventListener("turbo:load", init);
    document.addEventListener("DOMContentLoaded", init);
  })();
<% end %>
