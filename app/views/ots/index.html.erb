<%# app/views/ots/index.html.erb %>
<% content_for :title, "OTs" %>

<%# --- Mensajes --- %>
<% if notice.present? %>
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <%= notice %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
  </div>
<% end %>

<% if alert.present? %>
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <%= alert %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
  </div>
<% end %>

<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="h3 mb-0">OTs</h1>
  <%= link_to "Nueva OT", new_ot_path, class: "btn btn-primary" %>
</div>

<div class="card mb-3">
  <div class="card-body">
    <%= form_with url: import_ots_path, method: :post, html: { multipart: true, data: { turbo: false } }, class: "row g-3 align-items-end" do %>
      <div class="col-12 col-md-6">
        <label for="file" class="form-label fw-semibold">Archivo (.xlsx / .xls / .csv)</label>
        <%= file_field_tag :file, accept: ".xlsx,.xls,.csv", class: "form-control", id: "file" %>
      </div>
      <div class="col-auto">
        <%= submit_tag "Importar", class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>
</div>

<div class="d-flex justify-content-end mb-2">
  <span class="text-muted">Total registros: <strong><%= @ots.size %></strong></span>
</div>

<%= form_with url: ots_path, method: :get, local: true, class: "row g-2 align-items-center mb-3" do %>
  <div class="col-12 col-md-8 col-lg-6">
    <label for="q" class="form-label mb-1">Buscar</label>
    <div class="input-group">
      <%= text_field_tag :q, params[:q], id: "q", class: "form-control", placeholder: "OT, código, actividad, responsable, contratista, área, estado…" %>
      <button class="btn btn-outline-primary" type="submit">
        <i class="bi bi-search"></i> Buscar
      </button>
      <% if params[:q].present? %>
        <%= link_to "Limpiar", ots_path, class: "btn btn-outline-secondary" %>
      <% end %>
    </div>
    <% if params[:q].present? %>
      <small class="text-muted">Filtro aplicado: "<%= params[:q] %>"</small>
    <% end %>
  </div>
<% end %>


<% if @ots.any? %>
  <div class="table-responsive" style="max-height: 70vh;">
    <table class="table table-sm table-striped table-hover align-middle mb-0">
      <thead class="table-light position-sticky top-0" style="z-index: 1;">
        <tr>
          <th class="text-start">OT asignada</th>
          <th class="text-end">Semana</th>
          <th class="text-end">Item</th>
          <th class="text-start">Área</th>
          <th class="text-start">Código</th>
          <th class="text-start" style="min-width: 260px;">Actividad</th>
          <th class="text-end">Cant.</th>
          <th class="text-end">Unitario</th>
          <th class="text-end">Repuestos</th>
          <th class="text-end">Servicio</th>
          <th class="text-end">Total</th>
          <th class="text-start">Responsable</th>
          <th class="text-start">Contratista</th>
          <th class="text-start">Tipo OT</th>
          <th class="text-end">Estado</th>
          <th class="text-end">Sem. ejec.</th>
          <th class="text-center">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <% @ots.each do |ot| %>
          <tr>
            <td><%= ot.ot_asignada %></td>
            <td class="text-end"><%= ot.semana %></td>
            <td class="text-end"><%= ot.item %></td>
            <td><%= ot.area %></td>
            <td><%= ot.codigo %></td>
            <td class="text-truncate" title="<%= ot.actividad_semanal %>" style="max-width: 380px;"><%= ot.actividad_semanal %></td>
            <td class="text-end"><%= ot.cantidad %></td>
            <td class="text-end"><%= number_to_currency(ot.unitario, unit: "$", precision: 0, delimiter: ".") %></td>
            <td class="text-end"><%= number_to_currency(ot.repuestos, unit: "$", precision: 0, delimiter: ".") %></td>
            <td class="text-end"><%= number_to_currency(ot.servicio, unit: "$", precision: 0, delimiter: ".") %></td>
            <td class="text-end fw-semibold"><%= number_to_currency(ot.total, unit: "$", precision: 0, delimiter: ".") %></td>
            <td><%= ot.responsable %></td>
            <td><%= ot.contratista %></td>
            <td>
              <%# Badge según tipo_ot %>
              <% tipo_class =
                  case ot.tipo_ot.to_s.strip.downcase
                  when "u" then "bg-secondary"
                  when "a" then "bg-info"
                  when "c" then "bg-warning"
                  when "f" then "bg-danger"
                  when "i" then "bg-primary"
                  else "bg-dark"
                  end %>
              <span class="badge <%= tipo_class %>"><%= ot.tipo_ot %></span>
            </td>
            <td class="text-end">
              <%# Badge según estado %>
              <% estado = ot.estado.to_s.strip.downcase %>
              <% estado_class =
                  case estado
                  when "70" then "bg-warning text-dark"
                  when "80", "85" then "bg-success"
                  when "90" then "bg-secondary"
                  else "bg-light text-dark"
                  end %>
              <span class="badge <%= estado_class %>"><%= ot.estado %></span>
            </td>
            <td class="text-end"><%= ot.sem_ejec %></td>
            <td class="text-center">
              <div class="btn-group btn-group-sm" role="group" aria-label="Acciones">
                <%= link_to "Ver", ot, class: "btn btn-outline-secondary" %>
                <%= link_to "Editar", edit_ot_path(ot), class: "btn btn-outline-primary" %>
                <%= link_to "Eliminar", ot, method: :delete,
                      data: { turbo_confirm: "¿Eliminar OT #{ot.ot_asignada}?" },
                      class: "btn btn-outline-danger" %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
      <tfoot class="table-light">
        <tr>
          <td colspan="8" class="text-end fw-semibold">Totales:</td>
          <td class="text-end fw-semibold"><%= number_to_currency(@ots.sum(:repuestos), unit: "$", precision: 0, delimiter: ".") %></td>
          <td class="text-end fw-semibold"><%= number_to_currency(@ots.sum(:servicio), unit: "$", precision: 0, delimiter: ".") %></td>
          <td class="text-end fw-bold"><%= number_to_currency(@ots.sum(:total), unit: "$", precision: 0, delimiter: ".") %></td>
          <td colspan="5"></td>
        </tr>
      </tfoot>
    </table>
  </div>
<% else %>
  <div class="alert alert-info mb-0" role="alert">
    No hay OTs cargadas.
  </div>
<% end %>
