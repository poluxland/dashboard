<%# app/views/ots/index.html.erb %>
<% content_for :title, "OTs" %>



<%= render "search" %>




<%# --- Tabla / Lista: TODAS LAS COLUMNAS --- %>
<% if @ots&.any? %>
  <div class="table-responsive" style="max-height: 70vh;">
    <table class="table table-sm table-striped table-hover align-middle mb-0">
      <thead class="table-light position-sticky top-0" style="z-index: 1;">
        <tr>
          <th class="text-start">OT asignada</th>
          <th class="text-end">Semana</th>
          <th class="text-end">Item</th>
          <th class="text-start">Área</th>
          <th class="text-start">Código</th>
          <th class="text-start" style="min-width: 260px;">Actividad</th>
          <th class="text-start">ESP</th>
          <th class="text-end">Frecuencia</th>
          <th class="text-start">Cód rep.</th>
          <th class="text-end">Cant.</th>
          <th class="text-end">$ Unitario</th>
          <th class="text-end">$ Repuestos</th>
          <th class="text-end">$ Servicio</th>
          <th class="text-end fw-semibold">$ Total</th>
          <th class="text-start">Cotización</th>
          <th class="text-start">CC</th>
          <th class="text-start">Responsable</th>
          <th class="text-start">Contratista</th>
          <th class="text-start">Tipo OT</th>
          <th class="text-end">Estado</th>
          <th class="text-end">Sem. ejec.</th>
          <th class="text-end">N° Personas</th>
          <th class="text-end">Duración [hr]</th>
          <th class="text-end">HH</th>
          <th class="text-start">Causa</th>
          <th class="text-start" style="min-width: 240px;">Comentarios</th>
          <th class="text-center">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <% @ots.each do |ot| %>
          <tr>
            <td><%= ot.ot_asignada %></td>
            <td class="text-end"><%= ot.semana %></td>
            <td class="text-end"><%= ot.item %></td>
            <td><%= ot.area %></td>
            <td><%= ot.codigo %></td>
            <td class="text-truncate" title="<%= h ot.actividad_semanal %>" style="max-width: 380px;"><%= ot.actividad_semanal %></td>
            <td><%= ot.esp %></td>
            <td class="text-end"><%= ot.frecuencia %></td>
            <td><%= ot.cod_rep %></td>
            <td class="text-end"><%= ot.cantidad %></td>
            <td class="text-end"><%= number_to_currency(ot.unitario, unit: "", precision: 0, delimiter: ".") %></td>
            <td class="text-end"><%= number_to_currency(ot.repuestos, unit: "", precision: 0, delimiter: ".") %></td>
            <td class="text-end"><%= number_to_currency(ot.servicio, unit: "", precision: 0, delimiter: ".") %></td>
            <td class="text-end fw-semibold"><%= number_to_currency(ot.total, unit: "", precision: 0, delimiter: ".") %></td>
            <td><%= ot.cotizacion %></td>
            <td><%= ot.cc %></td>
            <td><%= ot.responsable %></td>
            <td><%= ot.contratista %></td>
            <td>
              <% tipo_class =
                case ot.tipo_ot.to_s.strip.downcase
                when "u" then "bg-secondary"
                when "a" then "bg-info"
                when "c" then "bg-warning"
                when "f" then "bg-danger"
                when "i" then "bg-primary"
                else "bg-dark"
                end %>
              <span class="badge <%= tipo_class %>"><%= ot.tipo_ot %></span>
            </td>
            <td class="text-end">
              <% estado = ot.estado.to_s.strip.downcase %>
              <% estado_class =
                case estado
                when "70" then "bg-warning text-dark"
                when "80", "85" then "bg-success"
                when "90" then "bg-secondary"
                else "bg-light text-dark"
                end %>
              <span class="badge <%= estado_class %>"><%= ot.estado %></span>
            </td>
            <td class="text-end"><%= ot.sem_ejec %></td>
            <td class="text-end"><%= ot.n_personas %></td>
            <td class="text-end"><%= ot.duracion_hr %></td>
            <td class="text-end"><%= ot.hh %></td>
            <td><%= ot.causa %></td>
            <td class="text-truncate" title="<%= h ot.comentarios %>" style="max-width: 360px;"><%= ot.comentarios %></td>
            <td class="text-center">
              <div class="btn-group btn-group-sm" role="group" aria-label="Acciones">
                <%= link_to "Ver", ot, class: "btn btn-outline-secondary" %>
                <%= link_to "Editar", edit_ot_path(ot), class: "btn btn-outline-primary" %>
                <%= link_to "Eliminar", ot, method: :delete,
                      data: { turbo_confirm: "¿Eliminar OT #{ot.ot_asignada}?" },
                      class: "btn btn-outline-danger" %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% else %>
  <div class="alert alert-info mb-0" role="alert">
    No hay OTs cargadas<%= " para “#{h params[:q]}”" if params[:q].present? %>.
  </div>
<% end %>
<div class="d-flex justify-content-center mt-3">
  <%= pagy_bootstrap_nav(@pagy).html_safe %>
</div>
